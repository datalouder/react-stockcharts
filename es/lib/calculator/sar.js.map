{"version":3,"sources":["../../../../src/lib/calculator/sar.js"],"names":["mappedSlidingWindow","isNotDefined","isDefined","SAR","defaultOptions","calc","prev","now","risingSar","af","risingEp","fallingSar","fallingEp","Math","max","high","min","low","options","calculator","data","accelerationFactor","maxAccelerationFactor","algorithm","windowSize","undefinedValue","accumulator","use","current","date","sar","calculatedData","map","d","undefinedLength","x","arguments","length"],"mappings":";;;;AAAA,SAASA,mBAAT,EAA8BC,YAA9B,EAA4CC,SAA5C,QAA6D,UAA7D;AACA,SAASC,OAAOC,cAAhB,QAAsC,gCAAtC;;AAEA,SAASC,IAAT,CAAcC,IAAd,EAAoBC,GAApB,EAAyB;AACvB,MAAMC,YAAYF,KAAKE,SAAL,GAAiBF,KAAKG,EAAL,IAAWH,KAAKI,QAAL,GAAgBJ,KAAKE,SAAhC,CAAnC;;AAEA,MAAMG,aACJL,KAAKK,UAAL,GAAkBL,KAAKG,EAAL,IAAWH,KAAKK,UAAL,GAAkBL,KAAKM,SAAlC,CADpB;;AAGA,MAAMF,WAAWG,KAAKC,GAAL,CAASR,KAAKI,QAAd,EAAwBH,IAAIQ,IAA5B,CAAjB;AACA,MAAMH,YAAYC,KAAKG,GAAL,CAASV,KAAKM,SAAd,EAAyBL,IAAIU,GAA7B,CAAlB;;AAEA,SAAO;AACLT,wBADK;AAELG,0BAFK;AAGLD,sBAHK;AAILE;AAJK,GAAP;AAMD;;AAED,eAAe,YAAY;AACzB,MAAIM,UAAUd,cAAd;;AAEA,WAASe,UAAT,CAAoBC,IAApB,EAA0B;AAAA,mBAC8BF,OAD9B;AAAA,QAChBG,kBADgB,YAChBA,kBADgB;AAAA,QACIC,qBADJ,YACIA,qBADJ;;;AAGxB,QAAMC,YAAYvB,sBACfwB,UADe,CACJ,CADI,EAEfC,cAFe,CAEA,gBAAmB;AAAA,UAAhBV,IAAgB,QAAhBA,IAAgB;AAAA,UAAVE,GAAU,QAAVA,GAAU;;AACjC,aAAO;AACLT,mBAAWS,GADN;AAELP,kBAAUK,IAFL;AAGLJ,oBAAYI,IAHP;AAILH,mBAAWK,GAJN;AAKLR,YAAIY;AALC,OAAP;AAOD,KAVe,EAWfK,WAXe,CAWH,iBAAiB;AAAA;AAAA,UAAfpB,IAAe;AAAA,UAATC,GAAS;;AAAA,kBAC2BF,KAAKC,IAAL,EAAWC,GAAX,CAD3B;AAAA,UACpBC,SADoB,SACpBA,SADoB;AAAA,UACTG,UADS,SACTA,UADS;AAAA,UACGD,QADH,SACGA,QADH;AAAA,UACaE,SADb,SACaA,SADb;;AAG5B,UACEX,aAAaK,KAAKqB,GAAlB,KACAnB,YAAYD,IAAIU,GADhB,IAEAN,aAAaJ,IAAIQ,IAHnB,EAIE;AACA,eAAO;AACLP,8BADK;AAELG,gCAFK;AAGLD,4BAHK;AAILE;AAJK,SAAP;AAMD;;AAED,UAAMe,MAAMzB,UAAUI,KAAKqB,GAAf,IACRrB,KAAKqB,GAAL,KAAa,QAAb,GACEnB,YAAYD,IAAIU,GAAhB,GACE,SADF,GAEE,QAHJ,GAIEN,aAAaJ,IAAIQ,IAAjB,GACA,QADA,GAEA,SAPM,GAQRP,YAAYD,IAAIU,GAAhB,GACA,SADA,GAEA,QAVJ;;AAYA,UAAMW,UACJtB,KAAKqB,GAAL,KAAaA,GAAb,GACI;AACElB,YAAII,KAAKG,GAAL,CACFM,qBADE,EAEFhB,KAAKG,EAAL,GAAUY,kBAFR,CADN;AAKET,4BALF;AAMEF,0BANF;AAOEC,8BAPF;AAQEH;AARF,OADJ,GAWI;AACEC,YAAIY,kBADN;AAEET,mBAAWL,IAAIU,GAFjB;AAGEP,kBAAUH,IAAIQ,IAHhB;AAIEJ,oBAAYE,KAAKC,GAAL,CAASR,KAAKI,QAAd,EAAwBH,IAAIQ,IAA5B,CAJd;AAKEP,mBAAWK,KAAKG,GAAL,CAASV,KAAKM,SAAd,EAAyBL,IAAIU,GAA7B;AALb,OAZN;;AA5B4B,UAgDpBY,IAhDoB,GAgDAtB,GAhDA,CAgDpBsB,IAhDoB;AAAA,UAgDdd,IAhDc,GAgDAR,GAhDA,CAgDdQ,IAhDc;AAAA,UAgDRE,GAhDQ,GAgDAV,GAhDA,CAgDRU,GAhDQ;;AAiD5B;AACEY,kBADF;AAEEd,kBAFF;AAGEE;AAHF,SAIKW,OAJL;AAKED,gBALF;AAMEG,aAAKH,QAAQ,SAAR,GAAoBC,QAAQjB,UAA5B,GAAyCiB,QAAQpB;AANxD;AAQD,KApEe,CAAlB;;AAsEA,QAAMuB,iBAAiBR,UAAUH,IAAV,EAAgBY,GAAhB,CAAoB;AAAA,aAAKC,EAAEH,GAAP;AAAA,KAApB,CAAvB;AACA;;AAEA,WAAOC,cAAP;AACD;AACDZ,aAAWe,eAAX,GAA6B,YAAY;AACvC,WAAO,CAAP;AACD,GAFD;AAGAf,aAAWD,OAAX,GAAqB,UAAUiB,CAAV,EAAa;AAChC,QAAI,CAACC,UAAUC,MAAf,EAAuB;AACrB,aAAOnB,OAAP;AACD;AACDA,2BAAed,cAAf,EAAkC+B,CAAlC;AACA,WAAOhB,UAAP;AACD,GAND;;AAQA,SAAOA,UAAP;AACD","file":"sar.js","sourcesContent":["import { mappedSlidingWindow, isNotDefined, isDefined } from '../utils';\nimport { SAR as defaultOptions } from './defaultOptionsForComputation';\n\nfunction calc(prev, now) {\n  const risingSar = prev.risingSar + prev.af * (prev.risingEp - prev.risingSar);\n\n  const fallingSar =\n    prev.fallingSar - prev.af * (prev.fallingSar - prev.fallingEp);\n\n  const risingEp = Math.max(prev.risingEp, now.high);\n  const fallingEp = Math.min(prev.fallingEp, now.low);\n\n  return {\n    risingSar,\n    fallingSar,\n    risingEp,\n    fallingEp,\n  };\n}\n\nexport default function () {\n  let options = defaultOptions;\n\n  function calculator(data) {\n    const { accelerationFactor, maxAccelerationFactor } = options;\n\n    const algorithm = mappedSlidingWindow()\n      .windowSize(2)\n      .undefinedValue(({ high, low }) => {\n        return {\n          risingSar: low,\n          risingEp: high,\n          fallingSar: high,\n          fallingEp: low,\n          af: accelerationFactor,\n        };\n      })\n      .accumulator(([prev, now]) => {\n        const { risingSar, fallingSar, risingEp, fallingEp } = calc(prev, now);\n\n        if (\n          isNotDefined(prev.use) &&\n          risingSar > now.low &&\n          fallingSar < now.high\n        ) {\n          return {\n            risingSar,\n            fallingSar,\n            risingEp,\n            fallingEp,\n          };\n        }\n\n        const use = isDefined(prev.use)\n          ? prev.use === 'rising'\n            ? risingSar > now.low\n              ? 'falling'\n              : 'rising'\n            : fallingSar < now.high\n            ? 'rising'\n            : 'falling'\n          : risingSar > now.low\n          ? 'falling'\n          : 'rising';\n\n        const current =\n          prev.use === use\n            ? {\n                af: Math.min(\n                  maxAccelerationFactor,\n                  prev.af + accelerationFactor\n                ),\n                fallingEp,\n                risingEp,\n                fallingSar,\n                risingSar,\n              }\n            : {\n                af: accelerationFactor,\n                fallingEp: now.low,\n                risingEp: now.high,\n                fallingSar: Math.max(prev.risingEp, now.high),\n                risingSar: Math.min(prev.fallingEp, now.low),\n              };\n\n        const { date, high, low } = now;\n        return {\n          date,\n          high,\n          low,\n          ...current,\n          use,\n          sar: use === 'falling' ? current.fallingSar : current.risingSar,\n        };\n      });\n\n    const calculatedData = algorithm(data).map(d => d.sar);\n    // console.log(calculatedData);\n\n    return calculatedData;\n  }\n  calculator.undefinedLength = function () {\n    return 1;\n  };\n  calculator.options = function (x) {\n    if (!arguments.length) {\n      return options;\n    }\n    options = { ...defaultOptions, ...x };\n    return calculator;\n  };\n\n  return calculator;\n}\n"]}