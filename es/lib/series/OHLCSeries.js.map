{"version":3,"sources":["../../../../src/lib/series/OHLCSeries.js"],"names":["nest","React","Component","PropTypes","GenericChartComponent","getAxisCanvas","isDefined","functor","OHLCSeries","props","renderSVG","bind","drawOnCanvas","ctx","moreProps","yAccessor","xAccessor","xScale","yScale","chartConfig","plotData","barData","getOHLCBars","clip","className","strokeWidth","bars","map","d","idx","stroke","openX1","openY","openX2","x","y1","y2","closeX1","closeY","closeX2","propTypes","string","classNames","oneOfType","func","isRequired","bool","defaultProps","open","high","low","close","absoluteChange","wickNest","key","entries","lineWidth","forEach","outer","values","strokeStyle","beginPath","moveTo","lineTo","classNamesProp","strokeProp","strokeFunc","classNameFunc","width","length","barWidth","Math","max","round","min","filter","ohlc"],"mappings":"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","file":"OHLCSeries.js","sourcesContent":["import { nest } from 'd3-collection';\nimport React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport GenericChartComponent from '../GenericChartComponent';\nimport { getAxisCanvas } from '../GenericComponent';\n\nimport { isDefined, functor } from '../utils';\n\nclass OHLCSeries extends Component {\n  constructor(props) {\n    super(props);\n    this.renderSVG = this.renderSVG.bind(this);\n    this.drawOnCanvas = this.drawOnCanvas.bind(this);\n  }\n  drawOnCanvas(ctx, moreProps) {\n    const { yAccessor } = this.props;\n    const { xAccessor } = moreProps;\n    const {\n      xScale,\n      chartConfig: { yScale },\n      plotData,\n    } = moreProps;\n\n    const barData = getOHLCBars(\n      this.props,\n      xAccessor,\n      yAccessor,\n      xScale,\n      yScale,\n      plotData\n    );\n    drawOnCanvas(ctx, barData);\n  }\n  render() {\n    const { clip } = this.props;\n\n    return (\n      <GenericChartComponent\n        svgDraw={this.renderSVG}\n        canvasToDraw={getAxisCanvas}\n        canvasDraw={this.drawOnCanvas}\n        clip={clip}\n        drawOn={['pan']}\n      />\n    );\n  }\n  renderSVG(moreProps) {\n    const { className, yAccessor } = this.props;\n    const { xAccessor } = moreProps;\n    const {\n      xScale,\n      chartConfig: { yScale },\n      plotData,\n    } = moreProps;\n\n    const barData = getOHLCBars(\n      this.props,\n      xAccessor,\n      yAccessor,\n      xScale,\n      yScale,\n      plotData\n    );\n\n    const { strokeWidth, bars } = barData;\n\n    return (\n      <g className={className}>\n        {bars.map((d, idx) => (\n          <path\n            key={idx}\n            className={d.className}\n            stroke={d.stroke}\n            strokeWidth={strokeWidth}\n            d={`M${d.openX1} ${d.openY} L${d.openX2} ${d.openY} M${d.x} ${d.y1} L${d.x} ${d.y2} M${d.closeX1} ${d.closeY} L${d.closeX2} ${d.closeY}`}\n          />\n        ))}\n      </g>\n    );\n  }\n}\n\nOHLCSeries.propTypes = {\n  className: PropTypes.string,\n  classNames: PropTypes.oneOfType([PropTypes.func, PropTypes.string])\n    .isRequired,\n  stroke: PropTypes.oneOfType([PropTypes.func, PropTypes.string]).isRequired,\n  yAccessor: PropTypes.func.isRequired,\n  clip: PropTypes.bool.isRequired,\n};\n\nOHLCSeries.defaultProps = {\n  className: 'react-stockcharts-ohlc',\n  yAccessor: d => ({ open: d.open, high: d.high, low: d.low, close: d.close }),\n  classNames: d =>\n    isDefined(d.absoluteChange)\n      ? d.absoluteChange > 0\n        ? 'up'\n        : 'down'\n      : 'firstbar',\n  stroke: d =>\n    isDefined(d.absoluteChange)\n      ? d.absoluteChange > 0\n        ? '#6BA583'\n        : '#FF0000'\n      : '#000000',\n  clip: true,\n};\n\nfunction drawOnCanvas(ctx, barData) {\n  const { strokeWidth, bars } = barData;\n\n  const wickNest = nest()\n    .key(d => d.stroke)\n    .entries(bars);\n\n  ctx.lineWidth = strokeWidth;\n\n  wickNest.forEach(outer => {\n    const { key, values } = outer;\n    ctx.strokeStyle = key;\n    values.forEach(d => {\n      ctx.beginPath();\n      ctx.moveTo(d.x, d.y1);\n      ctx.lineTo(d.x, d.y2);\n\n      ctx.moveTo(d.openX1, d.openY);\n      ctx.lineTo(d.openX2, d.openY);\n\n      ctx.moveTo(d.closeX1, d.closeY);\n      ctx.lineTo(d.closeX2, d.closeY);\n\n      ctx.stroke();\n    });\n  });\n}\n\nfunction getOHLCBars(props, xAccessor, yAccessor, xScale, yScale, plotData) {\n  const { classNames: classNamesProp, stroke: strokeProp } = props;\n\n  const strokeFunc = functor(strokeProp);\n  const classNameFunc = functor(classNamesProp);\n\n  const width =\n    xScale(xAccessor(plotData[plotData.length - 1])) -\n    xScale(xAccessor(plotData[0]));\n\n  const barWidth = Math.max(\n    1,\n    Math.round(width / (plotData.length - 1) / 2) - 1.5\n  );\n  const strokeWidth = Math.min(barWidth, 6);\n\n  const bars = plotData\n    .filter(d => isDefined(yAccessor(d).close))\n    .map(d => {\n      const ohlc = yAccessor(d),\n        x = Math.round(xScale(xAccessor(d))),\n        y1 = yScale(ohlc.high),\n        y2 = yScale(ohlc.low),\n        openX1 = x - barWidth,\n        openX2 = x + strokeWidth / 2,\n        openY = yScale(ohlc.open),\n        closeX1 = x - strokeWidth / 2,\n        closeX2 = x + barWidth,\n        closeY = yScale(ohlc.close),\n        className = classNameFunc(d),\n        stroke = strokeFunc(d);\n\n      return {\n        x,\n        y1,\n        y2,\n        openX1,\n        openX2,\n        openY,\n        closeX1,\n        closeX2,\n        closeY,\n        stroke,\n        className,\n      };\n    });\n  return { barWidth, strokeWidth, bars };\n}\n\nexport default OHLCSeries;\n"]}