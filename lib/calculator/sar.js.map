{"version":3,"sources":["../../../src/lib/calculator/sar.js"],"names":["options","defaultOptions","calculator","data","accelerationFactor","maxAccelerationFactor","algorithm","windowSize","undefinedValue","high","low","risingSar","risingEp","fallingSar","fallingEp","af","accumulator","prev","now","calc","use","current","Math","min","max","date","sar","calculatedData","map","d","undefinedLength","x","arguments","length"],"mappings":"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","file":"sar.js","sourcesContent":["import { mappedSlidingWindow, isNotDefined, isDefined } from '../utils';\nimport { SAR as defaultOptions } from './defaultOptionsForComputation';\n\nfunction calc(prev, now) {\n  const risingSar = prev.risingSar + prev.af * (prev.risingEp - prev.risingSar);\n\n  const fallingSar =\n    prev.fallingSar - prev.af * (prev.fallingSar - prev.fallingEp);\n\n  const risingEp = Math.max(prev.risingEp, now.high);\n  const fallingEp = Math.min(prev.fallingEp, now.low);\n\n  return {\n    risingSar,\n    fallingSar,\n    risingEp,\n    fallingEp,\n  };\n}\n\nexport default function () {\n  let options = defaultOptions;\n\n  function calculator(data) {\n    const { accelerationFactor, maxAccelerationFactor } = options;\n\n    const algorithm = mappedSlidingWindow()\n      .windowSize(2)\n      .undefinedValue(({ high, low }) => {\n        return {\n          risingSar: low,\n          risingEp: high,\n          fallingSar: high,\n          fallingEp: low,\n          af: accelerationFactor,\n        };\n      })\n      .accumulator(([prev, now]) => {\n        const { risingSar, fallingSar, risingEp, fallingEp } = calc(prev, now);\n\n        if (\n          isNotDefined(prev.use) &&\n          risingSar > now.low &&\n          fallingSar < now.high\n        ) {\n          return {\n            risingSar,\n            fallingSar,\n            risingEp,\n            fallingEp,\n          };\n        }\n\n        const use = isDefined(prev.use)\n          ? prev.use === 'rising'\n            ? risingSar > now.low\n              ? 'falling'\n              : 'rising'\n            : fallingSar < now.high\n            ? 'rising'\n            : 'falling'\n          : risingSar > now.low\n          ? 'falling'\n          : 'rising';\n\n        const current =\n          prev.use === use\n            ? {\n                af: Math.min(\n                  maxAccelerationFactor,\n                  prev.af + accelerationFactor\n                ),\n                fallingEp,\n                risingEp,\n                fallingSar,\n                risingSar,\n              }\n            : {\n                af: accelerationFactor,\n                fallingEp: now.low,\n                risingEp: now.high,\n                fallingSar: Math.max(prev.risingEp, now.high),\n                risingSar: Math.min(prev.fallingEp, now.low),\n              };\n\n        const { date, high, low } = now;\n        return {\n          date,\n          high,\n          low,\n          ...current,\n          use,\n          sar: use === 'falling' ? current.fallingSar : current.risingSar,\n        };\n      });\n\n    const calculatedData = algorithm(data).map(d => d.sar);\n    // console.log(calculatedData);\n\n    return calculatedData;\n  }\n  calculator.undefinedLength = function () {\n    return 1;\n  };\n  calculator.options = function (x) {\n    if (!arguments.length) {\n      return options;\n    }\n    options = { ...defaultOptions, ...x };\n    return calculator;\n  };\n\n  return calculator;\n}\n"]}