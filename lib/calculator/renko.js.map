{"version":3,"sources":["../../../src/lib/calculator/renko.js"],"names":["options","defaultOptions","dateAccessor","d","date","dateMutator","calculator","rawData","reversalType","fixedBrickSize","sourcePath","windowSize","source","high","low","close","pricingMethod","brickSize","atrAlgorithm","atrCalculator","algorithm","merge","c","renkoData","index","prevBrickClose","open","prevBrickOpen","brick","direction","forEach","idx","from","startOfYear","startOfQuarter","startOfMonth","startOfWeek","fromDate","volume","prevCloseToHigh","prevCloseToLow","prevOpenToHigh","prevOpenToLow","priceMovement","Math","min","abs","max","noOfBricks","floor","j","to","toDate","fullyFormed","push","newBrick","length","x","arguments"],"mappings":"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","file":"renko.js","sourcesContent":["import { merge, isNotDefined, functor } from '../utils';\n\nimport atr from './atr';\n\nimport { Renko as defaultOptions } from './defaultOptionsForComputation';\n\nexport default function () {\n  let options = defaultOptions;\n\n  let dateAccessor = d => d.date;\n  let dateMutator = (d, date) => {\n    d.date = date;\n  };\n\n  function calculator(rawData) {\n    const { reversalType, fixedBrickSize, sourcePath, windowSize } = options;\n\n    const source =\n      sourcePath === 'high/low'\n        ? d => {\n            return { high: d.high, low: d.low };\n          }\n        : d => {\n            return { high: d.close, low: d.close };\n          };\n\n    const pricingMethod = source;\n    let brickSize;\n\n    if (reversalType === 'ATR') {\n      // calculateATR(rawData, period);\n      const atrAlgorithm = atr().options({ windowSize });\n\n      const atrCalculator = merge()\n        .algorithm(atrAlgorithm)\n        .merge((d, c) => {\n          d['atr' + windowSize] = c;\n        });\n\n      atrCalculator(rawData);\n      brickSize = d => d['atr' + windowSize];\n    } else {\n      brickSize = functor(fixedBrickSize);\n    }\n\n    const renkoData = [];\n\n    let index = 0,\n      prevBrickClose = rawData[index].open,\n      prevBrickOpen = rawData[index].open;\n    let brick = {},\n      direction = 0;\n\n    rawData.forEach(function (d, idx) {\n      if (isNotDefined(brick.from)) {\n        brick.high = d.high;\n        brick.low = d.low;\n        brick.startOfYear = d.startOfYear;\n        brick.startOfQuarter = d.startOfQuarter;\n        brick.startOfMonth = d.startOfMonth;\n        brick.startOfWeek = d.startOfWeek;\n\n        brick.from = idx;\n        brick.fromDate = dateAccessor(d);\n        // indexMutator(brick, index++);\n        dateMutator(brick, dateAccessor(d));\n      }\n      brick.volume = (brick.volume || 0) + d.volume;\n\n      const prevCloseToHigh = prevBrickClose - pricingMethod(d).high,\n        prevCloseToLow = prevBrickClose - pricingMethod(d).low,\n        prevOpenToHigh = prevBrickOpen - pricingMethod(d).high,\n        prevOpenToLow = prevBrickOpen - pricingMethod(d).low,\n        priceMovement = Math.min(\n          Math.abs(prevCloseToHigh),\n          Math.abs(prevCloseToLow),\n          Math.abs(prevOpenToHigh),\n          Math.abs(prevOpenToLow)\n        );\n\n      brick.high = Math.max(brick.high, d.high);\n      brick.low = Math.min(brick.low, d.low);\n\n      if (!brick.startOfYear) {\n        brick.startOfYear = d.startOfYear;\n        if (brick.startOfYear) {\n          dateMutator(brick, dateAccessor(d));\n          // brick.displayDate = d.displayDate;\n        }\n      }\n\n      if (!brick.startOfQuarter) {\n        brick.startOfQuarter = d.startOfQuarter;\n        if (brick.startOfQuarter && !brick.startOfYear) {\n          dateMutator(brick, dateAccessor(d));\n          // brick.displayDate = d.displayDate;\n        }\n      }\n\n      if (!brick.startOfMonth) {\n        brick.startOfMonth = d.startOfMonth;\n        if (brick.startOfMonth && !brick.startOfQuarter) {\n          dateMutator(brick, dateAccessor(d));\n          // brick.displayDate = d.displayDate;\n        }\n      }\n      if (!brick.startOfWeek) {\n        brick.startOfWeek = d.startOfWeek;\n        if (brick.startOfWeek && !brick.startOfMonth) {\n          dateMutator(brick, dateAccessor(d));\n          // brick.displayDate = d.displayDate;\n        }\n      }\n\n      // d.brick = JSON.stringify(brick);\n      if (brickSize(d)) {\n        const noOfBricks = Math.floor(priceMovement / brickSize(d));\n\n        brick.open =\n          Math.abs(prevCloseToHigh) < Math.abs(prevOpenToHigh) ||\n          Math.abs(prevCloseToLow) < Math.abs(prevOpenToLow)\n            ? prevBrickClose\n            : prevBrickOpen;\n\n        if (noOfBricks >= 1) {\n          let j = 0;\n          for (j = 0; j < noOfBricks; j++) {\n            brick.close =\n              brick.open < pricingMethod(d).high\n                ? // if brick open is less than current price it means it is green/hollow brick\n                  brick.open + brickSize(d)\n                : brick.open - brickSize(d);\n            direction = brick.close > brick.open ? 1 : -1;\n            brick.direction = direction;\n            brick.to = idx;\n            brick.toDate = dateAccessor(d);\n            // brick.diff = brick.open - brick.close;\n            // brick.atr = d.atr;\n            brick.fullyFormed = true;\n            renkoData.push(brick);\n\n            prevBrickClose = brick.close;\n            prevBrickOpen = brick.open;\n\n            const newBrick = {\n              high: brick.high,\n              low: brick.low,\n              open: brick.close,\n              startOfYear: false,\n              startOfMonth: false,\n              startOfQuarter: false,\n              startOfWeek: false,\n            };\n            brick = newBrick;\n            brick.from = idx;\n            brick.fromDate = dateAccessor(d);\n            // indexMutator(brick, index + j);\n            dateMutator(brick, dateAccessor(d));\n            brick.volume = (brick.volume || 0) + d.volume;\n          }\n          index = index + j - 1;\n          brick = {};\n        } else {\n          if (idx === rawData.length - 1) {\n            brick.close =\n              direction > 0 ? pricingMethod(d).high : pricingMethod(d).low;\n            brick.to = idx;\n            brick.toDate = dateAccessor(d);\n            dateMutator(brick, dateAccessor(d));\n            brick.fullyFormed = false;\n            renkoData.push(brick);\n          }\n        }\n      }\n    });\n    return renkoData;\n  }\n  calculator.options = function (x) {\n    if (!arguments.length) {\n      return options;\n    }\n    options = { ...defaultOptions, ...x };\n    return calculator;\n  };\n\n  calculator.dateMutator = function (x) {\n    if (!arguments.length) return dateMutator;\n    dateMutator = x;\n    return calculator;\n  };\n  calculator.dateAccessor = function (x) {\n    if (!arguments.length) return dateAccessor;\n    dateAccessor = x;\n    return calculator;\n  };\n\n  return calculator;\n}\n"]}