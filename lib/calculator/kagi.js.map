{"version":3,"sources":["../../../src/lib/calculator/kagi.js"],"names":["options","defaultOptions","dateAccessor","d","date","dateMutator","calculator","data","reversalType","windowSize","reversal","sourcePath","source","reversalThreshold","atrAlgorithm","atrCalculator","algorithm","merge","c","kagiData","prevPeak","prevTrough","direction","line","forEach","from","open","high","low","close","startOfYear","startOfQuarter","startOfMonth","startOfWeek","volume","Math","max","min","to","priceMovement","changePoint","startAs","changeTo","abs","nextLineOpen","nextChangePoint","nextChangeTo","added","push","undefined","current","dir","reverseAt","x","arguments","length"],"mappings":"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","file":"kagi.js","sourcesContent":["import { merge, isNotDefined, path, functor } from '../utils';\nimport atr from './atr';\n\nimport { Kagi as defaultOptions } from './defaultOptionsForComputation';\n\nexport default function () {\n  let options = defaultOptions;\n  let dateAccessor = d => d.date;\n  let dateMutator = (d, date) => {\n    d.date = date;\n  };\n\n  function calculator(data) {\n    const { reversalType, windowSize, reversal, sourcePath } = options;\n\n    const source = path(sourcePath);\n    let reversalThreshold;\n\n    if (reversalType === 'ATR') {\n      // calculateATR(rawData, period);\n      const atrAlgorithm = atr().options({ windowSize });\n\n      const atrCalculator = merge()\n        .algorithm(atrAlgorithm)\n        .merge((d, c) => {\n          d['atr' + windowSize] = c;\n        });\n\n      atrCalculator(data);\n      reversalThreshold = d => d['atr' + windowSize];\n    } else {\n      reversalThreshold = functor(reversal);\n    }\n\n    const kagiData = [];\n\n    let prevPeak, prevTrough, direction;\n    let line = {};\n\n    data.forEach(function (d) {\n      if (isNotDefined(line.from)) {\n        dateMutator(line, dateAccessor(d));\n        line.from = dateAccessor(d);\n\n        if (!line.open) line.open = d.open;\n        line.high = d.high;\n        line.low = d.low;\n        if (!line.close) line.close = source(d);\n        line.startOfYear = d.startOfYear;\n        line.startOfQuarter = d.startOfQuarter;\n        line.startOfMonth = d.startOfMonth;\n        line.startOfWeek = d.startOfWeek;\n      }\n\n      if (!line.startOfYear) {\n        line.startOfYear = d.startOfYear;\n        if (line.startOfYear) {\n          line.date = d.date;\n          // line.displayDate = d.displayDate;\n        }\n      }\n\n      if (!line.startOfQuarter) {\n        line.startOfQuarter = d.startOfQuarter;\n        if (line.startOfQuarter && !line.startOfYear) {\n          line.date = d.date;\n          // line.displayDate = d.displayDate;\n        }\n      }\n\n      if (!line.startOfMonth) {\n        line.startOfMonth = d.startOfMonth;\n        if (line.startOfMonth && !line.startOfQuarter) {\n          line.date = d.date;\n          // line.displayDate = d.displayDate;\n        }\n      }\n      if (!line.startOfWeek) {\n        line.startOfWeek = d.startOfWeek;\n        if (line.startOfWeek && !line.startOfMonth) {\n          line.date = d.date;\n          // line.displayDate = d.displayDate;\n        }\n      }\n      line.volume = (line.volume || 0) + d.volume;\n      line.high = Math.max(line.high, d.high);\n      line.low = Math.min(line.low, d.low);\n      line.to = dateAccessor(d);\n\n      const priceMovement = source(d) - line.close;\n\n      // console.log(source(d), priceMovement)\n      if (\n        (line.close >= line.open /* going up */ &&\n          priceMovement > 0) /* and moving in same direction */ ||\n        (line.close < line.open /* going down */ &&\n          priceMovement < 0) /* and moving in same direction */\n      ) {\n        line.close = source(d);\n        if (prevTrough && line.close < prevTrough) {\n          // going below the prevTrough, so change from yang to yin\n          // A yin line forms when a Kagi line breaks below the prior trough.\n          line.changePoint = prevTrough;\n          if (line.startAs !== 'yin') {\n            line.changeTo = 'yin';\n            // line.startAs = \"yang\";\n          }\n        }\n        if (prevPeak && line.close > prevPeak) {\n          // going above the prevPeak, so change from yin to yang\n          // A yang line forms when a Kagi line breaks above the prior peak\n          line.changePoint = prevPeak;\n          if (line.startAs !== 'yang') {\n            line.changeTo = 'yang';\n            // line.startAs = \"yin\";\n          }\n        }\n      } else if (\n        (line.close >= line.open /* going up */ &&\n          priceMovement < 0 /* and moving in other direction */ &&\n          Math.abs(priceMovement) >\n            reversalThreshold(\n              d\n            )) /* and the movement is big enough for reversal */ ||\n        (line.close < line.open /* going down */ &&\n          priceMovement > 0 /* and moving in other direction */ &&\n          Math.abs(priceMovement) >\n            reversalThreshold(\n              d\n            )) /* and the movement is big enough for reversal */\n      ) {\n        // reverse direction\n        const nextLineOpen = line.close;\n\n        direction = (line.close - line.open) / Math.abs(line.close - line.open);\n\n        let nextChangePoint, nextChangeTo;\n        if (direction < 0 /* if direction so far has been -ve*/) {\n          // compare with line.close becomes prevTrough\n          if (isNotDefined(prevPeak)) prevPeak = line.open;\n          prevTrough = line.close;\n          if (source(d) > prevPeak) {\n            nextChangePoint = prevPeak;\n            nextChangeTo = 'yang';\n          }\n        } else {\n          if (isNotDefined(prevTrough)) prevTrough = line.open;\n          prevPeak = line.close;\n          if (source(d) < prevTrough) {\n            nextChangePoint = prevTrough;\n            nextChangeTo = 'yin';\n          }\n        }\n        if (isNotDefined(line.startAs)) {\n          line.startAs = direction > 0 ? 'yang' : 'yin';\n        }\n\n        const startAs = line.changeTo || line.startAs;\n        line.added = true;\n        kagiData.push(line);\n        direction = -1 * direction; // direction is reversed\n\n        line = { ...line };\n        line.open = nextLineOpen;\n        line.close = source(d);\n        line.startAs = startAs;\n        line.changePoint = nextChangePoint;\n        line.changeTo = nextChangeTo;\n        line.added = false;\n        line.from = undefined;\n        line.volume = 0;\n      } else {\n        // console.log(\"MOVING IN REV DIR BUT..\", line.open, line.close, source(d));\n      }\n      line.current = source(d);\n      let dir = line.close - line.open;\n      dir = dir === 0 ? 1 : dir / Math.abs(dir);\n      line.reverseAt =\n        dir > 0\n          ? line.close - reversalThreshold(d)\n          : line.open - reversalThreshold(d);\n    });\n    if (!line.added) kagiData.push(line);\n\n    return kagiData;\n  }\n  calculator.options = function (x) {\n    if (!arguments.length) {\n      return options;\n    }\n    options = { ...defaultOptions, ...x };\n    return calculator;\n  };\n  calculator.dateMutator = function (x) {\n    if (!arguments.length) return dateMutator;\n    dateMutator = x;\n    return calculator;\n  };\n  calculator.dateAccessor = function (x) {\n    if (!arguments.length) return dateAccessor;\n    dateAccessor = x;\n    return calculator;\n  };\n  return calculator;\n}\n"]}